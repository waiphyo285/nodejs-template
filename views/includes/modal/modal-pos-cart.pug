include ./modal-sale-voucher

div.modal.fade#dialogShoppingCart(tabindex='-1', role='dialog', aria-labelledby='dialogShoppingCart' data-backdrop="static" data-keyboard="false")
  div.modal-dialog.modal-lg.modal-dialog-centered.custom-fullview-lg(role='document')
    div.modal-content
      div.modal-header
        h5.modal-title  !{content.modal.shop_cart}
          
        .d-flex.justify-content-end
          h5.modal-title(style="color: var(--primary)")
            span.total-amount  0
            
          button.close(type='button', data-dismiss='modal', aria-label='Close')
            span(aria-hidden='true') &times;
      
      div.modal-body
        div.row
          .col-md-8
            form#cartModalForm.form-horizontal.form-validate(role='form' method="put", action="#" novalidate)
              .form-group
                // https://bootsnipp.com/snippets/O5mM8

                .table-responsive
                  table.table.table-bordered.shopping-cart
                    thead.text-muted
                      tr
                        th.text-center(style="min-width: 60px") 
                          | #
                        th.text-left(style="min-width: 120px")
                          | Product
                        th.text-center(style="min-width: 120px") 
                          | Quantity
                        th.text-right(style="min-width: 120px") 
                          | Sub Total
                    tbody

          .col-md-4  
            form#payModalForm.form-horizontal.form-validate(role='form' method="put", action="#" novalidate)
              .form-group.row
                div.col-md-12.mb-3
                  label.control-label(for='search_customer') !{content.customer} 
                  select.form-control.input-sm.page-select2-picker#searchCustomer(name="customer_id" data-live-search="true", data-size="8" )
                  span.invalid-feedback
                    | Please fill out this field. It is required to proceed.
                    
                .col-md-12.mb-3
                  label.control-label(for='pay_method') !{content.pay_method} *
                  select.form-control.input-sm.custom-select.none-select2-picker#payMethod(name='paymethod_id' data-live-search="true", data-size="8" required)
                  span.invalid-feedback
                    | Please fill out this field. It is required to proceed.

                .col-md-12.mb-3
                  label.control-label(for='description') !{content.description}
                  textarea.form-control.input-sm#description(name='remark', rows='3' required) Noted
                  span.invalid-feedback
                    | Please fill out this field. It is required to proceed.

                .col-md-8.mb-3
                  .input-group
                    input.form-control.form-control-sm(type='text' name='promo_code' placeholder='Promo code')
                    .input-group-append
                      button.btn.material-primary(type='button')
                        i.bi.bi-save
                        span  !{content.apply}

                .col-md-4.mb-3
                  .btn-group.btn-group-md.btn-group-toggle(data-toggle='buttons')
                    label.btn.btn-outline-secondary.btn-toggle.active
                      input(type='radio' name=`printed` value="1" autocomplete='off' checked)
                      |  Print 

                    label.btn.btn-outline-secondary.btn-toggle
                      input(type='radio' name=`printed` value="0" autocomplete='off')
                      |  No, yet

      div.modal-footer.d-flex.justify-content-between
        button.btn.material-button.material-secondary.w-100#dialogCancel(type='button', data-dismiss='modal')
          |  !{content.common.close}
        
        button.btn.material-button.material-primary.w-100#dialogUpdate(type='button', data-action="update")
          i.bi.bi-save
          |  !{content.common.update}

        button.btn.material-button.material-primary.w-100#dialogPay(type='button', data-action="payment")
          i.bi.bi-cash
          |  !{content.pay}

  script.
    $(document).ready(function() {
      const apiUrl = `/api/${v1}`

      $('#payMethod').select2({
        width: "100%",
        dropdownParent: $('#dialogShoppingCart')
      });

      ajaxLoadOption({
        type: "GET",
        url:"/bank",
        showKey: "name",
        selectId: "#payMethod",
        filterObj: { status: 1 },
        isSelected: true
      });

      ajaxLoadOption2({
        type: "GET",
        url:"/customer",
        showKey: "name",
        filterKey: "name",
        selectId: "#searchCustomer",
        dropdownParent: $("#dialogShoppingCart"),
        minLength: 3
      });

      $("#dialogUpdate").on('click', function() {
        const buttonType = $(this).data('action')
        const actionForm = buttonType == 'update' && '/sale-order'
        $('#cartModalForm').attr({ action: actionForm }).submit()
      })

      $("#dialogPay").on('click', function() {
        const form = $('#payModalForm')
        const isValidForm = form[0].checkValidity()

        if (!isValidForm) {
          form.addClass('was-validated')
          return
        }

        const buttonType = $(this).data('action')
        const actionForm = buttonType == 'payment' && '/pay-order'

        $('#dialogShoppingCart').modal('hide');
        $('#dialogPrintInvoice').modal('show');

        form.attr({ action: actionForm }).submit()
      })

      $('#cartModalForm').submit(function(e) {
        e.preventDefault();
        
        const itemList = [];
        const action = $(this).attr('action')
        const cartId = getLocalStoreData()
        const url = `${apiUrl}/${action}/${cartId}`

        $('tbody tr').not(":last").each(function() {
          itemList.push({
            item_id: $(this).find('.action .item-id').val(),
            quantity: $(this).find('.quantity input.value').val()
          });
        })

        panelServiceApi({
          url, 
          type: 'PUT',
          data: { itemList } 
        }, function(data) {
          if (data.data?.remove) {
            $("#cartCount").find('span:nth(1)').text('')
            localStoreService({ key: 'cartId', method: 'remove' })
          } 

          toastrWarning({
            type: 'success',
            title: content['modal'].success,
            description: content['user-msg'].cart_success,
          })
        })
      })

      $('#payModalForm').submit(function(e) {
        e.preventDefault();
        
        const data = {};
        const action = $(this).attr('action')
        const cartId = getLocalStoreData()
        const url = `${apiUrl}/${action}/${cartId}`
        const formData = $(this).serializeArray();

        formData.forEach(function (field) {
          data[field.name] = field.value;
        });

        panelServiceApi({
          url, 
          type: 'POST',
          data: data 
        }, function(data) {
          if (data.code === '200' || data.code === '201') {
            $("#cartCount").find('span:nth(1)').text('')
            localStoreService({ key: 'cartId', method: 'remove' })
            toastrWarning({
              type: 'success',
              title: content['modal'].success,
              description: content['user-msg'].pay_success,
            })
          }
        })
      })
    })
